<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kenya PAYE Calculator 2025 - AI-Powered</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #48bb78;
            --danger: #f56565;
            --warning: #ed8936;
            --info: #4299e1;
            --dark: #2d3748;
            --light: #f7fafc;
            --ai-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
            transition: background 0.3s ease;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            animation: fadeInDown 0.8s ease-out;
            position: relative;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .ai-badge {
            display: inline-block;
            background: var(--ai-gradient);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .nav-tab.active {
            background: white;
            color: var(--primary);
            transform: scale(1.05);
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.3);
        }

        .nav-tab.active:hover {
            background: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.8s ease-out;
        }

        .dark-mode .card {
            background: rgba(45, 55, 72, 0.95);
            color: #e2e8f0;
        }

        .ai-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(245,245,250,0.95) 100%);
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
        }

        .ai-card::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: var(--ai-gradient);
            border-radius: 20px;
            z-index: -1;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .dark-mode label {
            color: #cbd5e0;
        }

        input[type="number"], input[type="range"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .dark-mode input[type="number"], .dark-mode input[type="range"], .dark-mode select {
            background: #4a5568;
            border-color: #718096;
            color: white;
        }

        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .slider-container {
            margin-top: 10px;
        }

        .slider-value {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary);
            margin-top: 10px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .results-section {
            display: grid;
            gap: 20px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card .label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .summary-card .value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .summary-card .percentage {
            font-size: 0.8em;
            opacity: 0.8;
            margin-top: 5px;
        }

        .detailed-breakdown {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .dark-mode .detailed-breakdown {
            background: #4a5568;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .dark-mode .breakdown-item {
            border-color: #718096;
        }

        .breakdown-item:last-child {
            border-bottom: none;
        }

        .ai-insights {
            background: linear-gradient(135deg, #f6f9fc 0%, #e9ecef 100%);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }

        .dark-mode .ai-insights {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        }

        .ai-insight-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .dark-mode .ai-insight-item {
            background: #2d3748;
        }

        .ai-insight-item:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .ai-icon {
            font-size: 2em;
            margin-right: 15px;
            min-width: 50px;
        }

        .ai-content h4 {
            margin-bottom: 5px;
            color: var(--primary);
        }

        .ai-content p {
            margin: 0;
            color: #666;
            font-size: 0.95em;
        }

        .dark-mode .ai-content p {
            color: #a0aec0;
        }

        .optimization-card {
            background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .dark-mode .optimization-card {
            background: linear-gradient(135deg, #234e52 0%, #285e61 100%);
        }

        .optimization-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dark-mode .optimization-item {
            background: #2d3748;
        }

        .optimization-item:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .optimization-savings {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--success);
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            animation: slideIn 0.5s ease;
        }

        .alert-warning {
            background: #fff5f5;
            border-left: 4px solid var(--warning);
            color: #744210;
        }

        .alert-info {
            background: #e6f7ff;
            border-left: 4px solid var(--info);
            color: #0c5460;
        }

        .alert-success {
            background: #f0f9ff;
            border-left: 4px solid var(--success);
            color: #155724;
        }

        .dark-mode .alert {
            background: #2d3748;
            color: #e2e8f0;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.8s ease-out 0.3s both;
        }

        .dark-mode .chart-card {
            background: rgba(45, 55, 72, 0.95);
        }

        .chart-title {
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .dark-mode .chart-title {
            color: #e2e8f0;
        }

        canvas {
            max-height: 300px;
        }

        .prediction-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .dark-mode .metric-card {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
        }

        .metric-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .dark-mode .metric-label {
            color: #a0aec0;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .hidden {
            display: none;
        }

        .info-text {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .dark-mode .info-text {
            color: #a0aec0;
        }

        /* Enhanced Visualization Styles */
        #moneyFlow {
            position: relative;
            width: 100%;
            height: 400px;
            overflow: hidden;
            border-radius: 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        .money-particle {
            position: absolute;
            width: 30px;
            height: 15px;
            background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);
            border-radius: 4px;
            opacity: 0;
            font-size: 10px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(72, 187, 120, 0.5);
        }

        #threeDChart {
            width: 100%;
            height: 500px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .gauge-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin: 30px 0;
        }

        .gauge-item {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .gauge-canvas {
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }

        .gauge-label {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 15px;
            color: var(--primary);
        }

        .gauge-value {
            font-size: 2em;
            font-weight: bold;
            margin-top: 10px;
            background: var(--ai-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .health-score-container {
            text-align: center;
            padding: 40px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            margin: 30px 0;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .health-score-container {
            background: rgba(45, 55, 72, 0.95);
        }

        .health-score {
            font-size: 5em;
            font-weight: bold;
            background: var(--ai-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 20px 0;
            animation: pulseScore 2s ease-in-out infinite;
        }

        @keyframes pulseScore {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .health-status {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .health-status.excellent { color: var(--success); }
        .health-status.good { color: var(--info); }
        .health-status.fair { color: var(--warning); }
        .health-status.poor { color: var(--danger); }

        .ar-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 30px;
            background: var(--ai-gradient);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .ar-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        .financial-metrics-3d {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .metric-3d-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-3d-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
            animation: rotate 10s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .metric-3d-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
        }
    </style>
    <meta name="google-site-verification" content="googlee42d7f0c29356439" />
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="theme-toggle" onclick="toggleTheme()">üåô Dark Mode</button>
            <h1>üá∞üá™ Kenya PAYE Calculator 2025 <span class="ai-badge">AI-Powered</span></h1>
            <p>Advanced Tax Calculator with Smart Analytics & Predictions</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('calculator', event)">üí∞ Calculator</button>
            <button class="nav-tab" onclick="switchTab('ai-insights', event)">ü§ñ AI Insights</button>
            <button class="nav-tab" onclick="switchTab('predictions', event)">üìà Predictions</button>
            <button class="nav-tab" onclick="switchTab('optimization', event)">üéØ Optimization</button>
            <button class="nav-tab" onclick="switchTab('dashboard', event)">üé™ 3D Dashboard</button>
        </div>

        <!-- Calculator Tab -->
        <div id="calculator-tab" class="tab-content active">
            <div class="main-grid">
                <div class="card">
                    <h2>üìù Income Details</h2>
                    
                    <div class="input-group">
                        <label for="grossSalary">Gross Monthly Salary (KES)</label>
                        <input type="number" id="grossSalary" placeholder="50000" min="0" step="1000">
                        <div class="slider-container">
                            <input type="range" id="salarySlider" min="0" max="1000000" step="5000" value="50000">
                            <div class="slider-value" id="sliderValue">KES 50,000</div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="jobTitle">Job Title/Industry</label>
                        <select id="jobTitle">
                            <option value="">Select your field...</option>
                            <option value="tech">Technology/IT</option>
                            <option value="finance">Finance/Banking</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="education">Education</option>
                            <option value="retail">Retail/Sales</option>
                            <option value="manufacturing">Manufacturing</option>
                            <option value="government">Government/Public Service</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="experience">Years of Experience</label>
                        <input type="number" id="experience" placeholder="5" min="0" max="50">
                    </div>

                    <h3 style="margin-top: 30px; margin-bottom: 15px; color: var(--primary);">üìä Optional Deductions</h3>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="pensionCheck">
                        <label for="pensionCheck">Additional Pension Contribution</label>
                    </div>
                    <div class="input-group hidden" id="pensionGroup">
                        <input type="number" id="pension" placeholder="0" min="0" max="30000">
                        <p class="info-text">Max KES 30,000/month tax deductible</p>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="mortgageCheck">
                        <label for="mortgageCheck">Mortgage Interest</label>
                    </div>
                    <div class="input-group hidden" id="mortgageGroup">
                        <input type="number" id="mortgage" placeholder="0" min="0" max="30000">
                        <p class="info-text">Max KES 30,000/month tax deductible</p>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="insuranceCheck">
                        <label for="insuranceCheck">Life/Health/Education Insurance</label>
                    </div>
                    <div class="input-group hidden" id="insuranceGroup">
                        <input type="number" id="insurance" placeholder="0" min="0">
                        <p class="info-text">15% relief up to KES 60,000/year</p>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="medicalCheck">
                        <label for="medicalCheck">Post-Retirement Medical Fund</label>
                    </div>
                    <div class="input-group hidden" id="medicalGroup">
                        <input type="number" id="medical" placeholder="0" min="0" max="15000">
                        <p class="info-text">Max KES 15,000/month tax deductible</p>
                    </div>
                </div>

                <div class="results-section">
                    <div id="anomaly-alerts"></div>
                    
                    <div class="card">
                        <h2>üí∞ Summary Dashboard</h2>
                        
                        <div class="summary-cards">
                            <div class="summary-card" style="background: linear-gradient(135deg, #48bb78, #38a169);">
                                <div class="label">Net Salary</div>
                                <div class="value" id="netSummary">KES 0</div>
                                <div class="percentage" id="netPercentage">0% of gross</div>
                            </div>
                            <div class="summary-card" style="background: linear-gradient(135deg, #f56565, #e53e3e);">
                                <div class="label">Total Tax (PAYE)</div>
                                <div class="value" id="taxSummary">KES 0</div>
                                <div class="percentage" id="taxPercentage">0% of gross</div>
                            </div>
                            <div class="summary-card" style="background: linear-gradient(135deg, #4299e1, #3182ce);">
                                <div class="label">Total Deductions</div>
                                <div class="value" id="deductionsSummary">KES 0</div>
                                <div class="percentage" id="deductionsPercentage">0% of gross</div>
                            </div>
                            <div class="summary-card" style="background: linear-gradient(135deg, #ed8936, #dd6b20);">
                                <div class="label">Effective Tax Rate</div>
                                <div class="value" id="effectiveRate">0%</div>
                                <div class="percentage">After all reliefs</div>
                            </div>
                        </div>

                        <div class="detailed-breakdown">
                            <h3 style="margin-bottom: 15px;">üìã Detailed Breakdown</h3>
                            <div class="breakdown-item">
                                <span>Gross Salary</span>
                                <strong id="grossDetail">KES 0</strong>
                            </div>
                            <div class="breakdown-item">
                                <span>NSSF Contribution</span>
                                <strong id="nssfDetail">KES 0</strong>
                            </div>
                            <div class="breakdown-item">
                                <span>Taxable Income</span>
                                <strong id="taxableDetail">KES 0</strong>
                            </div>
                            <div class="breakdown-item">
                                <span>PAYE Tax</span>
                                <strong id="payeDetail">KES 0</strong>
                            </div>
                            <div class="breakdown-item">
                                <span>SHIF (2.75%)</span>
                                <strong id="shifDetail">KES 0</strong>
                            </div>
                            <div class="breakdown-item">
                                <span>Housing Levy (1.5%)</span>
                                <strong id="housingDetail">KES 0</strong>
                            </div>
                            <div class="breakdown-item" style="background: #e6fffa; margin-top: 10px; border-radius: 10px;">
                                <span style="font-weight: bold;">Net Take Home</span>
                                <strong id="netDetail" style="color: var(--success); font-size: 1.2em;">KES 0</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title">üíµ Income Flow Waterfall</h3>
                    <canvas id="waterfallChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">üç© Deductions Breakdown</h3>
                    <canvas id="deductionsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- AI Insights Tab -->
        <div id="ai-insights-tab" class="tab-content">
            <div class="ai-card card">
                <h2>ü§ñ AI-Powered Tax Insights <span class="loading" id="ai-loading" style="display: none;"></span></h2>
                
                <div id="ai-insights-content">
                    <div class="ai-insights">
                        <h3>üí° Personalized Recommendations</h3>
                        <div id="personalized-tips"></div>
                    </div>

                    <div class="ai-insights">
                        <h3>üìä Salary Analysis</h3>
                        <div id="salary-analysis"></div>
                    </div>

                    <div class="ai-insights">
                        <h3>üéØ Tax Efficiency Score</h3>
                        <div id="efficiency-score"></div>
                    </div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title">üìà Tax Efficiency Radar</h3>
                    <canvas id="efficiencyRadar"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">üí∞ Savings Potential</h3>
                    <canvas id="savingsPotential"></canvas>
                </div>
            </div>
        </div>

        <!-- Predictions Tab -->
        <div id="predictions-tab" class="tab-content">
            <div class="card">
                <h2>üìà Career & Tax Predictions</h2>
                
                <div class="prediction-controls">
                    <div class="input-group">
                        <label for="growthRate">Expected Annual Salary Growth (%)</label>
                        <input type="number" id="growthRate" value="10" min="0" max="50" step="1">
                    </div>
                    <div class="input-group">
                        <label for="yearsProjection">Years to Project</label>
                        <input type="number" id="yearsProjection" value="5" min="1" max="20" step="1">
                    </div>
                    <div class="input-group">
                        <label for="careerPath">Career Path</label>
                        <select id="careerPath">
                            <option value="linear">Steady Growth</option>
                            <option value="accelerated">Fast Track/Promotion</option>
                            <option value="entrepreneurial">Entrepreneurial</option>
                            <option value="conservative">Conservative</option>
                        </select>
                    </div>
                </div>

                <div class="summary-cards">
                    <div class="metric-card">
                        <div class="metric-value" id="projectedSalary">KES 0</div>
                        <div class="metric-label">Projected Salary (5 years)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="totalTaxPaid">KES 0</div>
                        <div class="metric-label">Total Tax (5 years)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="totalNetEarnings">KES 0</div>
                        <div class="metric-label">Total Net Earnings</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="taxRateChange">0%</div>
                        <div class="metric-label">Tax Rate Change</div>
                    </div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title">üìä Salary Growth Projection</h3>
                    <canvas id="salaryProjection"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">üí∏ Tax Burden Over Time</h3>
                    <canvas id="taxProjection"></canvas>
                </div>
            </div>
        </div>

        <!-- Optimization Tab -->
        <div id="optimization-tab" class="tab-content">
            <div class="ai-card card">
                <h2>üéØ Salary Structure Optimization</h2>
                
                <div class="alert alert-info">
                    <span style="margin-right: 10px;">üí°</span>
                    <span>AI analysis shows potential tax savings opportunities in your current salary structure</span>
                </div>

                <div class="optimization-card">
                    <h3>üöÄ Recommended Optimizations</h3>
                    <div id="optimization-suggestions"></div>
                </div>

                <div class="optimization-card" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
                    <h3>‚ö° Quick Wins</h3>
                    <div id="quick-wins"></div>
                </div>

                <div class="summary-cards" style="margin-top: 30px;">
                    <div class="metric-card">
                        <div class="metric-value" id="currentTaxBill">KES 0</div>
                        <div class="metric-label">Current Tax Bill</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="optimizedTaxBill">KES 0</div>
                        <div class="metric-label">Optimized Tax Bill</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="potentialSavings">KES 0</div>
                        <div class="metric-label">Potential Annual Savings</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="savingsPercentage">0%</div>
                        <div class="metric-label">Savings Percentage</div>
                    </div>
                </div>
            </div>

            <div class="chart-card">
                <h3 class="chart-title">üìä Optimization Comparison</h3>
                <canvas id="optimizationChart"></canvas>
            </div>
        </div>

        <!-- 3D Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <div class="health-score-container">
                <h2>üèÜ Financial Health Score</h2>
                <div class="health-score" id="healthScore">0</div>
                <div class="health-status" id="healthStatus">Calculating...</div>
                <p id="healthDescription">Analyzing your financial wellness...</p>
            </div>

            <div class="gauge-container">
                <div class="gauge-item">
                    <canvas class="gauge-canvas" id="taxEfficiencyGauge"></canvas>
                    <div class="gauge-label">Tax Efficiency</div>
                    <div class="gauge-value" id="taxEfficiencyValue">0%</div>
                </div>
                <div class="gauge-item">
                    <canvas class="gauge-canvas" id="savingsGauge"></canvas>
                    <div class="gauge-label">Savings Potential</div>
                    <div class="gauge-value" id="savingsValue">0%</div>
                </div>
                <div class="gauge-item">
                    <canvas class="gauge-canvas" id="incomeGrowthGauge"></canvas>
                    <div class="gauge-label">Income Growth</div>
                    <div class="gauge-value" id="incomeGrowthValue">0%</div>
                </div>
                <div class="gauge-item">
                    <canvas class="gauge-canvas" id="deductionUsageGauge"></canvas>
                    <div class="gauge-label">Deduction Usage</div>
                    <div class="gauge-value" id="deductionUsageValue">0%</div>
                </div>
            </div>

            <div class="card">
                <h3 style="text-align: center; margin-bottom: 30px;">üí∏ Animated Money Flow</h3>
                <div id="moneyFlow"></div>
            </div>

            <div class="card" style="margin-top: 30px;">
                <h3 style="text-align: center; margin-bottom: 30px;">üéØ 3D Financial Visualization</h3>
                <div id="threeDChart"></div>
            </div>

            <div class="financial-metrics-3d">
                <div class="metric-3d-card">
                    <h3>üìà Annual Projections</h3>
                    <div class="metric-value" id="annual-gross">KES 0</div>
                    <div class="metric-label">Annual Gross Income</div>
                </div>
                <div class="metric-3d-card">
                    <h3>üí∞ Take Home</h3>
                    <div class="metric-value" id="annual-net">KES 0</div>
                    <div class="metric-label">Annual Net Income</div>
                </div>
                <div class="metric-3d-card">
                    <h3>üéØ Tax Optimization</h3>
                    <div class="metric-value" id="optimization-potential">KES 0</div>
                    <div class="metric-label">Potential Annual Savings</div>
                </div>
            </div>

            <button class="ar-button" onclick="toggleAR()">ü•Ω View in AR</button>
        </div>
    </div>

    <script>
        // State variables
        let currentTab = 'calculator';
        let isDarkMode = false;
        let currentData = {};
        let aiAnalysisData = {};
        let charts = {};
        let gauges = {};
        let scene3D, camera3D, renderer3D;
        let moneyFlowInterval;

        // Tax brackets for 2025
        const taxBrackets = [
            { min: 0, max: 24000, rate: 0.10, name: "10% Bracket" },
            { min: 24001, max: 32333, rate: 0.25, name: "25% Bracket" },
            { min: 32334, max: 500000, rate: 0.30, name: "30% Bracket" },
            { min: 500001, max: 800000, rate: 0.325, name: "32.5% Bracket" },
            { min: 800001, max: Infinity, rate: 0.35, name: "35% Bracket" }
        ];

        const personalRelief = 2400;
        const insuranceReliefRate = 0.15;
        const insuranceReliefMax = 5000;

        // Industry salary benchmarks (simulated data)
        const industryBenchmarks = {
            tech: { junior: 50000, mid: 120000, senior: 250000, growth: 15 },
            finance: { junior: 60000, mid: 150000, senior: 300000, growth: 12 },
            healthcare: { junior: 45000, mid: 100000, senior: 200000, growth: 10 },
            education: { junior: 35000, mid: 70000, senior: 120000, growth: 8 },
            retail: { junior: 25000, mid: 50000, senior: 100000, growth: 7 },
            manufacturing: { junior: 40000, mid: 80000, senior: 150000, growth: 9 },
            government: { junior: 40000, mid: 75000, senior: 130000, growth: 6 },
            other: { junior: 35000, mid: 80000, senior: 150000, growth: 10 }
        };

        // Initialize all charts
        function initCharts() {
            // Waterfall Chart
            const ctxWaterfall = document.getElementById('waterfallChart').getContext('2d');
            charts.waterfall = new Chart(ctxWaterfall, {
                type: 'bar',
                data: {
                    labels: ['Gross', 'NSSF', 'PAYE', 'SHIF', 'Housing', 'Net'],
                    datasets: [{
                        label: 'Amount',
                        data: [0, 0, 0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(72, 187, 120, 0.8)',
                            'rgba(245, 101, 101, 0.8)',
                            'rgba(245, 101, 101, 0.8)',
                            'rgba(245, 101, 101, 0.8)',
                            'rgba(245, 101, 101, 0.8)',
                            'rgba(66, 153, 225, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => 'KES ' + value.toLocaleString()
                            }
                        }
                    }
                }
            });

            // Deductions Chart
            const ctxDeductions = document.getElementById('deductionsChart').getContext('2d');
            charts.deductions = new Chart(ctxDeductions, {
                type: 'doughnut',
                data: {
                    labels: ['Net Salary', 'PAYE', 'NSSF', 'SHIF', 'Housing Levy'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: ['#48bb78', '#f56565', '#4299e1', '#ed8936', '#9f7aea']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Efficiency Radar Chart
            const ctxRadar = document.getElementById('efficiencyRadar')?.getContext('2d');
            if (ctxRadar) {
                charts.efficiencyRadar = new Chart(ctxRadar, {
                    type: 'radar',
                    data: {
                        labels: ['Tax Efficiency', 'Deduction Usage', 'Salary Level', 'Growth Potential', 'Optimization'],
                        datasets: [{
                            label: 'Current',
                            data: [0, 0, 0, 0, 0],
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2
                        }, {
                            label: 'Optimal',
                            data: [100, 100, 100, 100, 100],
                            backgroundColor: 'rgba(72, 187, 120, 0.2)',
                            borderColor: 'rgba(72, 187, 120, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }

            // Savings Potential Chart
            const ctxSavings = document.getElementById('savingsPotential')?.getContext('2d');
            if (ctxSavings) {
                charts.savingsPotential = new Chart(ctxSavings, {
                    type: 'bar',
                    data: {
                        labels: ['Pension', 'Insurance', 'Mortgage', 'Medical Fund', 'Other'],
                        datasets: [{
                            label: 'Potential Monthly Savings',
                            data: [0, 0, 0, 0, 0],
                            backgroundColor: 'rgba(72, 187, 120, 0.8)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => 'KES ' + value.toLocaleString()
                                }
                            }
                        }
                    }
                });
            }

            // Salary Projection Chart
            const ctxProjection = document.getElementById('salaryProjection')?.getContext('2d');
            if (ctxProjection) {
                charts.salaryProjection = new Chart(ctxProjection, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Gross Salary',
                            data: [],
                            borderColor: 'rgba(102, 126, 234, 1)',
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            borderWidth: 3,
                            fill: true
                        }, {
                            label: 'Net Salary',
                            data: [],
                            borderColor: 'rgba(72, 187, 120, 1)',
                            backgroundColor: 'rgba(72, 187, 120, 0.2)',
                            borderWidth: 3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => 'KES ' + (value / 1000).toFixed(0) + 'K'
                                }
                            }
                        }
                    }
                });
            }

            // Tax Projection Chart
            const ctxTaxProjection = document.getElementById('taxProjection')?.getContext('2d');
            if (ctxTaxProjection) {
                charts.taxProjection = new Chart(ctxTaxProjection, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Annual Tax',
                            data: [],
                            backgroundColor: 'rgba(245, 101, 101, 0.8)'
                        }, {
                            label: 'Effective Tax Rate',
                            data: [],
                            type: 'line',
                            yAxisID: 'y1',
                            borderColor: 'rgba(237, 137, 54, 1)',
                            borderWidth: 3,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => 'KES ' + (value / 1000).toFixed(0) + 'K'
                                }
                            },
                            y1: {
                                position: 'right',
                                beginAtZero: true,
                                max: 40,
                                ticks: {
                                    callback: value => value + '%'
                                }
                            }
                        }
                    }
                });
            }

            // Optimization Chart
            const ctxOptimization = document.getElementById('optimizationChart')?.getContext('2d');
            if (ctxOptimization) {
                charts.optimization = new Chart(ctxOptimization, {
                    type: 'bar',
                    data: {
                        labels: ['Current', 'Optimized'],
                        datasets: [{
                            label: 'Gross Salary',
                            data: [0, 0],
                            backgroundColor: 'rgba(102, 126, 234, 0.8)'
                        }, {
                            label: 'Total Tax',
                            data: [0, 0],
                            backgroundColor: 'rgba(245, 101, 101, 0.8)'
                        }, {
                            label: 'Net Income',
                            data: [0, 0],
                            backgroundColor: 'rgba(72, 187, 120, 0.8)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => 'KES ' + value.toLocaleString()
                                }
                            }
                        }
                    }
                });
            }
        }

        // Calculate NSSF
        function calculateNSSF(gross) {
            const tierILimit = 8000;
            const tierIILimit = 72000;
            const rate = 0.06;

            if (gross <= tierILimit) {
                return gross * rate;
            } else if (gross <= tierIILimit) {
                const tierI = tierILimit * rate;
                const tierII = (gross - tierILimit) * rate;
                return tierI + tierII;
            } else {
                const tierI = tierILimit * rate;
                const tierII = (tierIILimit - tierILimit) * rate;
                return tierI + tierII;
            }
        }

        // Calculate PAYE with bracket breakdown
        function calculatePAYE(taxableIncome) {
            let tax = 0;
            let remainingIncome = taxableIncome;
            let bracketTaxes = [];

            for (const bracket of taxBrackets) {
                if (remainingIncome <= 0) {
                    bracketTaxes.push(0);
                    continue;
                }
                
                const taxableInBracket = Math.min(remainingIncome, bracket.max - bracket.min + 1);
                const bracketTax = taxableInBracket * bracket.rate;
                bracketTaxes.push(bracketTax);
                tax += bracketTax;
                remainingIncome -= taxableInBracket;
            }

            return { total: tax, brackets: bracketTaxes };
        }

        // Calculate SHIF
        function calculateSHIF(gross) {
            return Math.max(300, gross * 0.0275);
        }

        // Calculate Housing Levy
        function calculateHousingLevy(gross) {
            return gross * 0.015;
        }

        // AI Analysis Functions
        function performAIAnalysis() {
            const gross = parseFloat(document.getElementById('grossSalary').value) || 0;
            if (gross === 0) return;
            
            document.getElementById('ai-loading').style.display = 'inline-block';
            
            setTimeout(() => {
                const industry = document.getElementById('jobTitle').value;
                const experience = parseFloat(document.getElementById('experience').value) || 0;
                
                // Analyze salary position
                const salaryAnalysis = analyzeSalaryPosition(gross, industry, experience);
                
                // Generate personalized tips
                const tips = generatePersonalizedTips(currentData);
                
                // Calculate efficiency score
                const efficiencyScore = calculateEfficiencyScore(currentData);
                
                // Detect anomalies
                detectAnomalies(currentData);
                
                // Update AI insights
                updateAIInsights(salaryAnalysis, tips, efficiencyScore);
                
                // Update optimization suggestions
                generateOptimizationSuggestions(currentData);
                
                document.getElementById('ai-loading').style.display = 'none';
            }, 1000);
        }

        function analyzeSalaryPosition(gross, industry, experience) {
            if (!industry || !industryBenchmarks[industry]) return null;
            
            const benchmark = industryBenchmarks[industry];
            let level = 'junior';
            let expectedSalary = benchmark.junior;
            
            if (experience >= 10) {
                level = 'senior';
                expectedSalary = benchmark.senior;
            } else if (experience >= 5) {
                level = 'mid';
                expectedSalary = benchmark.mid;
            }
            
            const percentile = expectedSalary > 0 ? (gross / expectedSalary) * 100 : 0;
            
            return {
                level,
                expectedSalary,
                percentile,
                comparison: gross > expectedSalary ? 'above' : gross < expectedSalary ? 'below' : 'at',
                growth: benchmark.growth
            };
        }

        function generatePersonalizedTips(data) {
            const tips = [];
            const { gross, nssf, paye, totalDeductions, netSalary } = data;
            
            // Pension optimization
            if (!document.getElementById('pensionCheck').checked) {
                const potentialSaving = calculatePotentialPensionSaving(gross);
                tips.push({
                    icon: 'üíº',
                    title: 'Maximize Pension Contributions',
                    description: `Contributing KES ${potentialSaving.contribution.toLocaleString()} monthly to pension could save you KES ${potentialSaving.taxSaving.toLocaleString()} in taxes.`,
                    priority: 'high'
                });
            }
            
            // Insurance relief
            if (!document.getElementById('insuranceCheck').checked) {
                tips.push({
                    icon: 'üè•',
                    title: 'Utilize Insurance Relief',
                    description: 'Get 15% tax relief on life, health, or education insurance premiums up to KES 60,000/year.',
                    priority: 'medium'
                });
            }
            
            // Mortgage interest
            if (!document.getElementById('mortgageCheck').checked && gross > 100000) {
                tips.push({
                    icon: 'üè†',
                    title: 'Home Ownership Benefits',
                    description: 'Mortgage interest payments up to KES 30,000/month are tax deductible.',
                    priority: 'medium'
                });
            }
            
            // Tax efficiency
            const effectiveRate = gross > 0 ? (paye / gross) * 100 : 0;
            if (effectiveRate > 25) {
                tips.push({
                    icon: 'üìä',
                    title: 'High Tax Bracket Alert',
                    description: 'Your effective tax rate is high. Consider salary restructuring options.',
                    priority: 'high'
                });
            }
            
            return tips;
        }

        function calculateEfficiencyScore(data) {
            const { gross, paye, totalDeductions } = data;
            
            // Calculate various efficiency metrics
            const taxEfficiency = gross > 0 ? Math.max(0, 100 - ((paye / gross) * 100)) : 0;
            const deductionUsage = calculateDeductionUsage();
            const salaryLevel = Math.min(100, (gross / 200000) * 100);
            const growthPotential = calculateGrowthPotential();
            const optimization = calculateOptimizationScore();
            
            return {
                overall: Math.round((taxEfficiency + deductionUsage + salaryLevel + growthPotential + optimization) / 5),
                breakdown: {
                    taxEfficiency: Math.round(taxEfficiency),
                    deductionUsage: Math.round(deductionUsage),
                    salaryLevel: Math.round(salaryLevel),
                    growthPotential: Math.round(growthPotential),
                    optimization: Math.round(optimization)
                }
            };
        }

        function calculateDeductionUsage() {
            let score = 0;
            if (document.getElementById('pensionCheck').checked) score += 25;
            if (document.getElementById('insuranceCheck').checked) score += 25;
            if (document.getElementById('mortgageCheck').checked) score += 25;
            // Base score for mandatory deductions
            return score + 25;
        }

        function calculateGrowthPotential() {
            const industry = document.getElementById('jobTitle').value;
            const experience = parseFloat(document.getElementById('experience').value) || 0;
            
            if (!industry || !industryBenchmarks[industry]) return 50;
            
            const growthRate = industryBenchmarks[industry].growth;
            const careerStage = experience < 5 ? 1.5 : experience < 10 ? 1.2 : 1;
            
            return Math.min(100, growthRate * careerStage * 5);
        }

        function calculateOptimizationScore() {
            const gross = parseFloat(document.getElementById('grossSalary').value) || 0;
            if (gross === 0) return 0;
            
            const potentialSavings = calculateTotalPotentialSavings(gross);
            const actualSavings = calculateActualSavings();
            
            return potentialSavings > 0 && actualSavings > 0 ? Math.min(100, (actualSavings / potentialSavings) * 100) : 0;
        }

        function detectAnomalies(data) {
            const alerts = document.getElementById('anomaly-alerts');
            alerts.innerHTML = '';
            
            const { gross, nssf, paye, shif, housingLevy } = data;
            
            // Check for unusual NSSF
            const expectedNSSF = calculateNSSF(gross);
            if (Math.abs(nssf - expectedNSSF) > 10) {
                addAlert('warning', '‚ö†Ô∏è NSSF calculation seems incorrect. Please verify your inputs.');
            }
            
            // Check for very high tax rate
            const effectiveRate = gross > 0 ? (paye / gross) * 100 : 0;
            if (effectiveRate > 30) {
                addAlert('info', 'üìä Your effective tax rate is quite high. Consider exploring tax optimization strategies.');
            }
            
            // Check for missing common deductions
            if (gross > 100000 && !document.getElementById('pensionCheck').checked) {
                addAlert('success', 'üí° You may be missing out on pension contribution tax benefits.');
            }
        }

        function addAlert(type, message) {
            const alerts = document.getElementById('anomaly-alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            alerts.appendChild(alert);
        }

        function updateAIInsights(salaryAnalysis, tips, efficiencyScore) {
            // Update personalized tips
            const tipsContainer = document.getElementById('personalized-tips');
            tipsContainer.innerHTML = tips.map(tip => `
                <div class="ai-insight-item">
                    <div class="ai-icon">${tip.icon}</div>
                    <div class="ai-content">
                        <h4>${tip.title}</h4>
                        <p>${tip.description}</p>
                    </div>
                </div>
            `).join('');
            
            // Update salary analysis
            const analysisContainer = document.getElementById('salary-analysis');
            if (salaryAnalysis) {
                analysisContainer.innerHTML = `
                    <div class="ai-insight-item">
                        <div class="ai-icon">üìä</div>
                        <div class="ai-content">
                            <h4>Industry Position</h4>
                            <p>Your salary is ${salaryAnalysis.comparison} the ${salaryAnalysis.level} level average of KES ${salaryAnalysis.expectedSalary.toLocaleString()} in ${document.getElementById('jobTitle').selectedOptions[0].text}.</p>
                        </div>
                    </div>
                    <div class="ai-insight-item">
                        <div class="ai-icon">üìà</div>
                        <div class="ai-content">
                            <h4>Growth Potential</h4>
                            <p>Your industry typically sees ${salaryAnalysis.growth}% annual growth. You're in the ${Math.round(salaryAnalysis.percentile)}th percentile.</p>
                        </div>
                    </div>
                `;
            }
            
            // Update efficiency score
            const scoreContainer = document.getElementById('efficiency-score');
            scoreContainer.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 3em; font-weight: bold; color: ${efficiencyScore.overall > 70 ? 'var(--success)' : efficiencyScore.overall > 40 ? 'var(--warning)' : 'var(--danger)'};">
                        ${efficiencyScore.overall}%
                    </div>
                    <p>Overall Tax Efficiency Score</p>
                </div>
            `;
            
            // Update radar chart
            if (charts.efficiencyRadar) {
                charts.efficiencyRadar.data.datasets[0].data = [
                    efficiencyScore.breakdown.taxEfficiency,
                    efficiencyScore.breakdown.deductionUsage,
                    efficiencyScore.breakdown.salaryLevel,
                    efficiencyScore.breakdown.growthPotential,
                    efficiencyScore.breakdown.optimization
                ];
                charts.efficiencyRadar.update();
            }
            
            // Update savings potential chart
            updateSavingsPotentialChart();
        }

        function calculatePotentialPensionSaving(gross) {
            const maxContribution = Math.min(30000, gross * 0.1);
            const taxableReduction = maxContribution;
            const nssfAmount = calculateNSSF(gross);
            const currentTax = calculatePAYE(gross - nssfAmount).total;
            const newTax = calculatePAYE(gross - nssfAmount - taxableReduction).total;
            const taxSaving = currentTax - newTax;
            
            return {
                contribution: maxContribution,
                taxSaving: Math.max(0, taxSaving)
            };
        }

        function calculateTotalPotentialSavings(gross) {
            let totalSavings = 0;
            const nssfAmount = calculateNSSF(gross);
            
            // Pension savings
            if (!document.getElementById('pensionCheck').checked) {
                totalSavings += calculatePotentialPensionSaving(gross).taxSaving;
            }
            
            // Insurance relief
            if (!document.getElementById('insuranceCheck').checked) {
                totalSavings += insuranceReliefMax;
            }
            
            // Mortgage interest (estimate)
            if (!document.getElementById('mortgageCheck').checked && gross > 100000) {
                const currentTax = calculatePAYE(gross - nssfAmount).total;
                const newTax = calculatePAYE(gross - nssfAmount - 20000).total;
                const mortgageSaving = currentTax - newTax;
                totalSavings += Math.max(0, mortgageSaving);
            }
            
            return totalSavings;
        }

        function calculateActualSavings() {
            // Calculate current tax savings from deductions
            const gross = parseFloat(document.getElementById('grossSalary').value) || 0;
            const nssfAmount = calculateNSSF(gross);
            const basePayE = calculatePAYE(gross - nssfAmount).total;
            const actualPayE = currentData.paye || 0;
            
            return Math.max(0, basePayE - actualPayE - personalRelief);
        }

        function updateSavingsPotentialChart() {
            const gross = parseFloat(document.getElementById('grossSalary').value) || 0;
            const nssfAmount = calculateNSSF(gross);
            
            const pensionSaving = !document.getElementById('pensionCheck').checked ? 
                calculatePotentialPensionSaving(gross).taxSaving : 0;
            
            const insuranceSaving = !document.getElementById('insuranceCheck').checked ? 
                insuranceReliefMax * 0.5 : 0; // Estimate
            
            let mortgageSaving = 0;
            if (!document.getElementById('mortgageCheck').checked && gross > 100000) {
                const currentTax = calculatePAYE(gross - nssfAmount).total;
                const newTax = calculatePAYE(gross - nssfAmount - 20000).total;
                mortgageSaving = currentTax - newTax;
            }
            
            let medicalSaving = 0;
            if (!document.getElementById('medicalCheck').checked) {
                const currentTax = calculatePAYE(gross - nssfAmount).total;
                const newTax = calculatePAYE(gross - nssfAmount - 10000).total;
                medicalSaving = currentTax - newTax;
            }
            
            if (charts.savingsPotential) {
                charts.savingsPotential.data.datasets[0].data = [
                    Math.max(0, pensionSaving),
                    Math.max(0, insuranceSaving),
                    Math.max(0, mortgageSaving),
                    Math.max(0, medicalSaving),
                    0
                ];
                charts.savingsPotential.update();
            }
        }

        function generateOptimizationSuggestions(data) {
            const { gross, paye } = data;
            const suggestionsContainer = document.getElementById('optimization-suggestions');
            const quickWinsContainer = document.getElementById('quick-wins');
            
            const suggestions = [];
            const quickWins = [];
            
            // Major optimizations
            if (!document.getElementById('pensionCheck').checked) {
                const saving = calculatePotentialPensionSaving(gross);
                suggestions.push({
                    title: 'Maximize Pension Contributions',
                    description: `Contribute KES ${saving.contribution.toLocaleString()} monthly`,
                    saving: saving.taxSaving
                });
            }
            
            // Quick wins
            if (!document.getElementById('insuranceCheck').checked) {
                quickWins.push({
                    title: 'Add Insurance Policy',
                    description: 'Get 15% relief on premiums',
                    saving: 2000 // Estimate
                });
            }
            
            // Update UI
            suggestionsContainer.innerHTML = suggestions.map(s => `
                <div class="optimization-item" onclick="applyOptimization('${s.title}')">
                    <div>
                        <strong>${s.title}</strong>
                        <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #666;">${s.description}</p>
                    </div>
                    <div class="optimization-savings">+KES ${s.saving.toLocaleString()}</div>
                </div>
            `).join('');
            
            quickWinsContainer.innerHTML = quickWins.map(w => `
                <div class="optimization-item" onclick="applyQuickWin('${w.title}')">
                    <div>
                        <strong>${w.title}</strong>
                        <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #666;">${w.description}</p>
                    </div>
                    <div class="optimization-savings">+KES ${w.saving.toLocaleString()}</div>
                </div>
            `).join('');
            
            // Update optimization metrics
            updateOptimizationMetrics();
        }

        function updateOptimizationMetrics() {
            const gross = parseFloat(document.getElementById('grossSalary').value) || 0;
            const currentTax = currentData.paye || 0;
            const potentialSavings = calculateTotalPotentialSavings(gross);
            const optimizedTax = Math.max(0, currentTax - potentialSavings);
            
            document.getElementById('currentTaxBill').textContent = `KES ${(currentTax * 12).toLocaleString()}`;
            document.getElementById('optimizedTaxBill').textContent = `KES ${(optimizedTax * 12).toLocaleString()}`;
            document.getElementById('potentialSavings').textContent = `KES ${(potentialSavings * 12).toLocaleString()}`;
            document.getElementById('savingsPercentage').textContent = `${currentTax > 0 ? Math.round((potentialSavings / currentTax) * 100) : 0}%`;
            
            // Update optimization chart
            if (charts.optimization) {
                const netIncome = gross - currentData.totalDeductions;
                const optimizedNetIncome = gross - (currentData.totalDeductions - potentialSavings);
                
                charts.optimization.data.datasets[0].data = [gross, gross];
                charts.optimization.data.datasets[1].data = [currentTax, optimizedTax];
                charts.optimization.data.datasets[2].data = [Math.max(0, netIncome), Math.max(0, optimizedNetIncome)];
                charts.optimization.update();
            }
        }

        function updateProjections() {
            const gross = parseFloat(document.getElementById('grossSalary').value) || 0;
            const growthRate = parseFloat(document.getElementById('growthRate')?.value) || 10;
            const years = parseFloat(document.getElementById('yearsProjection')?.value) || 5;
            const careerPath = document.getElementById('careerPath')?.value || 'linear';
            
            if (gross === 0) return;
            
            const projectionData = calculateProjections(gross, growthRate, years, careerPath);
            
            // Update metrics if elements exist
            const projectedSalaryEl = document.getElementById('projectedSalary');
            if (projectedSalaryEl) {
                projectedSalaryEl.textContent = `KES ${projectionData.finalSalary.toLocaleString()}`;
            }
            
            const totalTaxPaidEl = document.getElementById('totalTaxPaid');
            if (totalTaxPaidEl) {
                totalTaxPaidEl.textContent = `KES ${projectionData.totalTax.toLocaleString()}`;
            }
            
            const totalNetEarningsEl = document.getElementById('totalNetEarnings');
            if (totalNetEarningsEl) {
                totalNetEarningsEl.textContent = `KES ${projectionData.totalNet.toLocaleString()}`;
            }
            
            const taxRateChangeEl = document.getElementById('taxRateChange');
            if (taxRateChangeEl) {
                taxRateChangeEl.textContent = `${projectionData.taxRateChange > 0 ? '+' : ''}${projectionData.taxRateChange.toFixed(1)}%`;
            }
            
            // Update charts
            updateProjectionCharts(projectionData);
        }

        function calculateProjections(startSalary, baseGrowthRate, years, careerPath) {
            const labels = [];
            const grossSalaries = [];
            const netSalaries = [];
            const annualTaxes = [];
            const effectiveRates = [];
            
            let totalTax = 0;
            let totalNet = 0;
            
            for (let year = 0; year <= years; year++) {
                labels.push(`Year ${year}`);
                
                // Adjust growth based on career path
                let growthMultiplier = 1;
                if (careerPath === 'accelerated') {
                    growthMultiplier = 1.5 - (year * 0.05); // Starts high, normalizes
                } else if (careerPath === 'entrepreneurial') {
                    growthMultiplier = year < 2 ? 0.5 : 2; // Slow start, rapid growth
                } else if (careerPath === 'conservative') {
                    growthMultiplier = 0.7;
                }
                
                const adjustedGrowth = baseGrowthRate * growthMultiplier;
                const salary = startSalary * Math.pow(1 + adjustedGrowth / 100, year);
                
                // Calculate taxes for this salary
                const nssf = calculateNSSF(salary);
                const taxableIncome = salary - nssf;
                const payeResult = calculatePAYE(taxableIncome);
                const paye = Math.max(0, payeResult.total - personalRelief);
                const shif = calculateSHIF(salary);
                const housingLevy = calculateHousingLevy(salary);
                const totalDeductions = nssf + paye + shif + housingLevy;
                const netSalary = salary - totalDeductions;
                
                grossSalaries.push(salary * 12);
                netSalaries.push(netSalary * 12);
                annualTaxes.push(paye * 12);
                effectiveRates.push((paye / salary) * 100);
                
                if (year > 0) {
                    totalTax += paye * 12;
                    totalNet += netSalary * 12;
                }
            }
            
            const initialRate = effectiveRates[0];
            const finalRate = effectiveRates[effectiveRates.length - 1];
            
            return {
                labels,
                grossSalaries,
                netSalaries,
                annualTaxes,
                effectiveRates,
                totalTax,
                totalNet,
                finalSalary: grossSalaries[grossSalaries.length - 1] / 12,
                taxRateChange: finalRate - initialRate
            };
        }

        function updateProjectionCharts(data) {
            // Update salary projection chart
            if (charts.salaryProjection) {
                charts.salaryProjection.data.labels = data.labels;
                charts.salaryProjection.data.datasets[0].data = data.grossSalaries;
                charts.salaryProjection.data.datasets[1].data = data.netSalaries;
                charts.salaryProjection.update();
            }
            
            // Update tax projection chart
            if (charts.taxProjection) {
                charts.taxProjection.data.labels = data.labels;
                charts.taxProjection.data.datasets[0].data = data.annualTaxes;
                charts.taxProjection.data.datasets[1].data = data.effectiveRates;
                charts.taxProjection.update();
            }
        }

        // Main calculation function
        function calculate() {
            const gross = parseFloat(document.getElementById('grossSalary').value) || 0;
            const pensionContribution = document.getElementById('pensionCheck').checked ? 
                Math.min(parseFloat(document.getElementById('pension').value) || 0, 30000) : 0;
            const mortgageInterest = document.getElementById('mortgageCheck').checked ? 
                Math.min(parseFloat(document.getElementById('mortgage').value) || 0, 30000) : 0;
            const insurancePremium = document.getElementById('insuranceCheck').checked ? 
                parseFloat(document.getElementById('insurance').value) || 0 : 0;
            const medicalFund = document.getElementById('medicalCheck').checked ? 
                Math.min(parseFloat(document.getElementById('medical').value) || 0, 15000) : 0;

            // Calculate deductions
            const nssf = calculateNSSF(gross);
            const taxableIncome = Math.max(0, gross - nssf - pensionContribution - mortgageInterest - medicalFund);
            
            const payeResult = calculatePAYE(taxableIncome);
            let grossPaye = payeResult.total;
            let paye = Math.max(0, grossPaye - personalRelief);
            
            // Apply insurance relief
            let insuranceRelief = 0;
            if (insurancePremium > 0) {
                insuranceRelief = Math.min(insurancePremium * insuranceReliefRate, insuranceReliefMax);
                paye = Math.max(0, paye - insuranceRelief);
            }
            
            const shif = calculateSHIF(gross);
            const housingLevy = calculateHousingLevy(gross);
            
            const totalDeductions = nssf + paye + shif + housingLevy;
            const netSalary = Math.max(0, gross - totalDeductions);

            // Store current data
            currentData = {
                gross, nssf, taxableIncome, grossPaye, paye, shif, housingLevy,
                totalDeductions, netSalary, insuranceRelief, payeBrackets: payeResult.brackets
            };

            // Update UI
            updateUI();
            
            // Perform AI analysis
            if (gross > 0) {
                performAIAnalysis();
                updateProjections();
            }
        }

        function updateUI() {
            const { gross, netSalary, paye, totalDeductions, nssf, shif, housingLevy } = currentData;
            
            // Update summary cards
            document.getElementById('netSummary').textContent = `KES ${netSalary.toLocaleString()}`;
            document.getElementById('netPercentage').textContent = `${gross > 0 ? ((netSalary / gross) * 100).toFixed(1) : 0}% of gross`;
            
            document.getElementById('taxSummary').textContent = `KES ${paye.toLocaleString()}`;
            document.getElementById('taxPercentage').textContent = `${gross > 0 ? ((paye / gross) * 100).toFixed(1) : 0}% of gross`;
            
            document.getElementById('deductionsSummary').textContent = `KES ${totalDeductions.toLocaleString()}`;
            document.getElementById('deductionsPercentage').textContent = `${gross > 0 ? ((totalDeductions / gross) * 100).toFixed(1) : 0}% of gross`;
            
            const effectiveRate = gross > 0 ? ((paye / gross) * 100).toFixed(1) : 0;
            document.getElementById('effectiveRate').textContent = `${effectiveRate}%`;
            
            // Update detailed breakdown
            document.getElementById('grossDetail').textContent = `KES ${gross.toLocaleString()}`;
            document.getElementById('nssfDetail').textContent = `KES ${nssf.toLocaleString()}`;
            document.getElementById('taxableDetail').textContent = `KES ${currentData.taxableIncome.toLocaleString()}`;
            document.getElementById('payeDetail').textContent = `KES ${paye.toLocaleString()}`;
            document.getElementById('shifDetail').textContent = `KES ${shif.toLocaleString()}`;
            document.getElementById('housingDetail').textContent = `KES ${housingLevy.toLocaleString()}`;
            document.getElementById('netDetail').textContent = `KES ${netSalary.toLocaleString()}`;
            
            // Update charts
            updateCharts();
        }

        function updateCharts() {
            const data = currentData;

            // Update Waterfall Chart
            if (charts.waterfall) {
                charts.waterfall.data.datasets[0].data = [
                    data.gross,
                    -data.nssf,
                    -data.paye,
                    -data.shif,
                    -data.housingLevy,
                    data.netSalary
                ];
                charts.waterfall.update();
            }

            // Update Deductions Chart
            if (charts.deductions) {
                charts.deductions.data.datasets[0].data = [
                    data.netSalary,
                    data.paye,
                    data.nssf,
                    data.shif,
                    data.housingLevy
                ];
                charts.deductions.update();
            }
        }

        // Tab switching
        function switchTab(tabName, event) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                document.querySelector(`.nav-tab:nth-child(${
                    tabName === 'calculator' ? 1 : 
                    tabName === 'ai-insights' ? 2 : 
                    tabName === 'predictions' ? 3 : 
                    tabName === 'optimization' ? 4 : 5
                })`).classList.add('active');
            }
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Initialize charts if needed
            if (!charts.efficiencyRadar && tabName === 'ai-insights') {
                setTimeout(() => {
                    initCharts();
                    performAIAnalysis();
                }, 100);
            }
            
            if (!charts.salaryProjection && tabName === 'predictions') {
                setTimeout(() => {
                    initCharts();
                    updateProjections();
                }, 100);
            }
            
            if (!charts.optimization && tabName === 'optimization') {
                setTimeout(() => {
                    initCharts();
                    generateOptimizationSuggestions(currentData);
                }, 100);
            }
            
            if (tabName === 'dashboard') {
                setTimeout(() => {
                    if (!scene3D) {
                        init3DChart();
                    } else {
                        create3DBars();
                    }
                    updateHealthScore();
                    updateFinancialMetrics3D();
                    startMoneyFlow();
                    
                    // Initialize gauges if not already done
                    if (Object.keys(gauges).length === 0 && typeof Gauge !== 'undefined') {
                        initGauges();
                        updateGauges();
                    }
                }, 100);
            } else {
                stopMoneyFlow();
            }
        }

        // Theme toggle
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            document.querySelector('.theme-toggle').textContent = isDarkMode ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
        }

        // Apply optimization suggestion
        function applyOptimization(type) {
            if (type.includes('Pension')) {
                document.getElementById('pensionCheck').checked = true;
                document.getElementById('pensionGroup').classList.remove('hidden');
                const gross = parseFloat(document.getElementById('grossSalary').value) || 0;
                if (gross > 0) {
                    document.getElementById('pension').value = Math.min(30000, gross * 0.1);
                }
            }
            calculate();
        }

        function applyQuickWin(type) {
            if (type.includes('Insurance')) {
                document.getElementById('insuranceCheck').checked = true;
                document.getElementById('insuranceGroup').classList.remove('hidden');
                document.getElementById('insurance').value = 5000;
            }
            calculate();
        }

        // Event listeners
        document.getElementById('grossSalary').addEventListener('input', function() {
            document.getElementById('salarySlider').value = this.value;
            document.getElementById('sliderValue').textContent = `KES ${parseFloat(this.value || 0).toLocaleString()}`;
            calculate();
        });

        document.getElementById('salarySlider').addEventListener('input', function() {
            document.getElementById('grossSalary').value = this.value;
            document.getElementById('sliderValue').textContent = `KES ${parseFloat(this.value || 0).toLocaleString()}`;
            calculate();
        });

        document.getElementById('jobTitle').addEventListener('change', calculate);
        document.getElementById('experience').addEventListener('change', calculate);
        document.getElementById('pension').addEventListener('input', calculate);
        document.getElementById('mortgage').addEventListener('input', calculate);
        document.getElementById('insurance').addEventListener('input', calculate);
        document.getElementById('medical').addEventListener('input', calculate);

        // Checkbox toggles
        document.getElementById('pensionCheck').addEventListener('change', function() {
            document.getElementById('pensionGroup').classList.toggle('hidden', !this.checked);
            calculate();
        });

        document.getElementById('mortgageCheck').addEventListener('change', function() {
            document.getElementById('mortgageGroup').classList.toggle('hidden', !this.checked);
            calculate();
        });

        document.getElementById('insuranceCheck').addEventListener('change', function() {
            document.getElementById('insuranceGroup').classList.toggle('hidden', !this.checked);
            calculate();
        });

        document.getElementById('medicalCheck').addEventListener('change', function() {
            document.getElementById('medicalGroup').classList.toggle('hidden', !this.checked);
            calculate();
        });

        // Projection controls
        document.getElementById('growthRate')?.addEventListener('input', updateProjections);
        document.getElementById('yearsProjection')?.addEventListener('input', updateProjections);
        document.getElementById('careerPath')?.addEventListener('change', updateProjections);

        // Enhanced Visualization Functions
        function initGauges() {
            const gaugeOptions = {
                angle: -0.2,
                lineWidth: 0.2,
                radiusScale: 0.75,
                pointer: {
                    length: 0.6,
                    strokeWidth: 0.05,
                    color: '#000000'
                },
                limitMax: false,
                limitMin: false,
                colorStart: '#667eea',
                colorStop: '#764ba2',
                strokeColor: '#E0E0E0',
                generateGradient: true,
                highDpiSupport: true,
                staticZones: [
                    {strokeStyle: "#f56565", min: 0, max: 30},
                    {strokeStyle: "#ed8936", min: 30, max: 60},
                    {strokeStyle: "#48bb78", min: 60, max: 100}
                ]
            };

            // Initialize all gauges
            const gaugeElements = [
                'taxEfficiencyGauge',
                'savingsGauge',
                'incomeGrowthGauge',
                'deductionUsageGauge'
            ];

            gaugeElements.forEach(id => {
                const canvas = document.getElementById(id);
                if (canvas) {
                    const gauge = new Gauge(canvas).setOptions(gaugeOptions);
                    gauge.maxValue = 100;
                    gauge.animationSpeed = 50;
                    gauge.set(0);
                    gauges[id] = gauge;
                }
            });
        }

        function updateGauges() {
            const efficiencyScore = calculateEfficiencyScore(currentData);
            
            if (gauges.taxEfficiencyGauge) {
                gauges.taxEfficiencyGauge.set(efficiencyScore.breakdown.taxEfficiency);
                document.getElementById('taxEfficiencyValue').textContent = `${efficiencyScore.breakdown.taxEfficiency}%`;
            }
            
            if (gauges.savingsGauge) {
                const savingsPotential = calculateSavingsPotential();
                gauges.savingsGauge.set(savingsPotential);
                document.getElementById('savingsValue').textContent = `${savingsPotential}%`;
            }
            
            if (gauges.incomeGrowthGauge) {
                gauges.incomeGrowthGauge.set(efficiencyScore.breakdown.growthPotential);
                document.getElementById('incomeGrowthValue').textContent = `${efficiencyScore.breakdown.growthPotential}%`;
            }
            
            if (gauges.deductionUsageGauge) {
                gauges.deductionUsageGauge.set(efficiencyScore.breakdown.deductionUsage);
                document.getElementById('deductionUsageValue').textContent = `${efficiencyScore.breakdown.deductionUsage}%`;
            }
        }

        function calculateSavingsPotential() {
            const gross = parseFloat(document.getElementById('grossSalary').value) || 0;
            if (gross === 0) return 0;
            
            const potentialSavings = calculateTotalPotentialSavings(gross);
            const maxPossibleSavings = gross * 0.15; // Assume 15% max savings potential
            
            return Math.min(100, (potentialSavings / maxPossibleSavings) * 100);
        }

        function updateHealthScore() {
            const efficiencyScore = calculateEfficiencyScore(currentData);
            const overallScore = efficiencyScore.overall;
            
            document.getElementById('healthScore').textContent = overallScore;
            
            let status, description;
            const statusEl = document.getElementById('healthStatus');
            
            statusEl.className = 'health-status';
            
            if (overallScore >= 80) {
                status = 'Excellent';
                description = 'Your financial health is outstanding! Keep up the great work.';
                statusEl.classList.add('excellent');
            } else if (overallScore >= 60) {
                status = 'Good';
                description = 'You\'re doing well, but there\'s room for improvement.';
                statusEl.classList.add('good');
            } else if (overallScore >= 40) {
                status = 'Fair';
                description = 'Consider implementing our optimization suggestions.';
                statusEl.classList.add('fair');
            } else {
                status = 'Needs Attention';
                description = 'Let\'s work on improving your financial efficiency.';
                statusEl.classList.add('poor');
            }
            
            statusEl.textContent = status;
            document.getElementById('healthDescription').textContent = description;
            
            // Animate the score
            animateHealthScore(overallScore);
        }

        function animateHealthScore(targetScore) {
            const scoreEl = document.getElementById('healthScore');
            let currentScore = 0;
            const increment = targetScore / 50;
            
            const interval = setInterval(() => {
                currentScore += increment;
                if (currentScore >= targetScore) {
                    currentScore = targetScore;
                    clearInterval(interval);
                }
                scoreEl.textContent = Math.round(currentScore);
            }, 20);
        }

        function init3DChart() {
            const container = document.getElementById('threeDChart');
            if (!container) return;
            
            // Scene setup
            scene3D = new THREE.Scene();
            scene3D.background = new THREE.Color(0x0a0a0a);
            scene3D.fog = new THREE.Fog(0x0a0a0a, 10, 50);
            
            // Camera setup
            camera3D = new THREE.PerspectiveCamera(
                75,
                container.clientWidth / container.clientHeight,
                0.1,
                1000
            );
            camera3D.position.set(0, 5, 10);
            camera3D.lookAt(0, 0, 0);
            
            // Renderer setup
            renderer3D = new THREE.WebGLRenderer({ antialias: true });
            renderer3D.setSize(container.clientWidth, container.clientHeight);
            renderer3D.shadowMap.enabled = true;
            renderer3D.shadowMap.type = THREE.PCFSoftShadowMap;
            container.innerHTML = '';
            container.appendChild(renderer3D.domElement);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene3D.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 20, 10);
            directionalLight.castShadow = true;
            scene3D.add(directionalLight);
            
            // Create 3D bars for financial data
            create3DBars();
            
            // Animation loop
            animate3D();
        }

        function create3DBars() {
            if (!scene3D || !currentData.gross) return;
            
            // Clear existing meshes
            while(scene3D.children.length > 2) {
                scene3D.remove(scene3D.children[scene3D.children.length - 1]);
            }
            
            const data = [
                { label: 'Gross', value: currentData.gross, color: 0x667eea },
                { label: 'Net', value: currentData.netSalary, color: 0x48bb78 },
                { label: 'Tax', value: currentData.paye, color: 0xf56565 },
                { label: 'Deductions', value: currentData.totalDeductions, color: 0xed8936 }
            ];
            
            const maxValue = Math.max(...data.map(d => d.value));
            
            data.forEach((item, index) => {
                const height = (item.value / maxValue) * 8;
                const geometry = new THREE.BoxGeometry(1.5, height, 1.5);
                const material = new THREE.MeshPhongMaterial({
                    color: item.color,
                    emissive: item.color,
                    emissiveIntensity: 0.2
                });
                
                const bar = new THREE.Mesh(geometry, material);
                bar.position.set((index - 1.5) * 2.5, height / 2, 0);
                bar.castShadow = true;
                bar.receiveShadow = true;
                
                // Add floating animation
                bar.userData = {
                    floatSpeed: 0.001 + Math.random() * 0.002,
                    floatOffset: Math.random() * Math.PI * 2
                };
                
                scene3D.add(bar);
                
                // Add glowing particles around bars
                addParticles(bar.position, item.color);
            });
            
            // Add ground plane
            const planeGeometry = new THREE.PlaneGeometry(20, 20);
            const planeMaterial = new THREE.MeshStandardMaterial({
                color: 0x1a1a2e,
                metalness: 0.5,
                roughness: 0.5
            });
            const plane = new THREE.Mesh(planeGeometry, planeMaterial);
            plane.rotation.x = -Math.PI / 2;
            plane.position.y = 0;
            plane.receiveShadow = true;
            scene3D.add(plane);
        }

        function addParticles(position, color) {
            const particleCount = 20;
            const geometry = new THREE.BufferGeometry();
            const positions = [];
            
            for (let i = 0; i < particleCount; i++) {
                positions.push(
                    position.x + (Math.random() - 0.5) * 2,
                    position.y + Math.random() * 2,
                    position.z + (Math.random() - 0.5) * 2
                );
            }
            
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            
            const material = new THREE.PointsMaterial({
                color: color,
                size: 0.1,
                transparent: true,
                opacity: 0.6,
                blending: THREE.AdditiveBlending
            });
            
            const particles = new THREE.Points(geometry, material);
            scene3D.add(particles);
        }

        function animate3D() {
            if (!renderer3D || !scene3D || !camera3D) return;
            
            requestAnimationFrame(animate3D);
            
            // Rotate camera around the scene
            const time = Date.now() * 0.0005;
            camera3D.position.x = Math.cos(time) * 15;
            camera3D.position.z = Math.sin(time) * 15;
            camera3D.lookAt(0, 2, 0);
            
            // Animate bars
            scene3D.children.forEach(child => {
                if (child.userData && child.userData.floatSpeed) {
                    child.position.y += Math.sin(time * child.userData.floatSpeed + child.userData.floatOffset) * 0.01;
                    child.rotation.y = time * 0.5;
                }
            });
            
            renderer3D.render(scene3D, camera3D);
        }

        function startMoneyFlow() {
            const container = document.getElementById('moneyFlow');
            if (!container) return;
            
            stopMoneyFlow(); // Clear any existing animation
            
            const { gross, netSalary, totalDeductions } = currentData;
            if (!gross) return;
            
            moneyFlowInterval = setInterval(() => {
                createMoneyParticle(container, gross, netSalary, totalDeductions);
            }, 200);
        }

        function stopMoneyFlow() {
            if (moneyFlowInterval) {
                clearInterval(moneyFlowInterval);
                moneyFlowInterval = null;
            }
            
            const container = document.getElementById('moneyFlow');
            if (container) {
                container.innerHTML = '';
            }
        }

        function createMoneyParticle(container, gross, netSalary, deductions) {
            const particle = document.createElement('div');
            particle.className = 'money-particle';
            particle.textContent = 'KES';
            
            const isDeduction = Math.random() < (deductions / gross);
            
            if (isDeduction) {
                particle.style.background = 'linear-gradient(90deg, #f56565 0%, #e53e3e 100%)';
                particle.style.boxShadow = '0 0 10px rgba(245, 101, 101, 0.5)';
            }
            
            particle.style.left = '10px';
            particle.style.top = Math.random() * (container.offsetHeight - 30) + 'px';
            
            container.appendChild(particle);
            
            // Animate particle
            gsap.to(particle, {
                left: container.offsetWidth - 40,
                opacity: 1,
                duration: 3,
                ease: "power2.inOut",
                onComplete: () => {
                    particle.remove();
                }
            });
            
            gsap.to(particle, {
                y: isDeduction ? -100 : 0,
                duration: 3,
                ease: isDeduction ? "power2.out" : "none"
            });
        }

        function updateFinancialMetrics3D() {
            const { gross, netSalary } = currentData;
            
            document.getElementById('annual-gross').textContent = `KES ${(gross * 12).toLocaleString()}`;
            document.getElementById('annual-net').textContent = `KES ${(netSalary * 12).toLocaleString()}`;
            
            const potentialSavings = calculateTotalPotentialSavings(gross);
            document.getElementById('optimization-potential').textContent = `KES ${(potentialSavings * 12).toLocaleString()}`;
        }

        function toggleAR() {
            // AR Mode simulation (real AR would require WebXR API)
            alert('AR Mode would display your financial data in augmented reality using your device camera. This feature requires WebXR support and HTTPS connection.');
            
            // For demo purposes, we'll create a fullscreen 3D view
            if (renderer3D && renderer3D.domElement) {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    renderer3D.domElement.requestFullscreen();
                }
            }
        }

        // Update the tab switching function to handle the dashboard
        function switchTab(tabName, event) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                document.querySelector(`.nav-tab:nth-child(${
                    tabName === 'calculator' ? 1 : 
                    tabName === 'ai-insights' ? 2 : 
                    tabName === 'predictions' ? 3 : 
                    tabName === 'optimization' ? 4 : 5
                })`).classList.add('active');
            }
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Initialize charts if needed
            if (!charts.efficiencyRadar && tabName === 'ai-insights') {
                setTimeout(() => {
                    initCharts();
                    performAIAnalysis();
                }, 100);
            }
            
            if (!charts.salaryProjection && tabName === 'predictions') {
                setTimeout(() => {
                    initCharts();
                    updateProjections();
                }, 100);
            }
            
            if (!charts.optimization && tabName === 'optimization') {
                setTimeout(() => {
                    initCharts();
                    generateOptimizationSuggestions(currentData);
                }, 100);
            }
            
            if (tabName === 'dashboard') {
                setTimeout(() => {
                    if (!scene3D) {
                        init3DChart();
                    } else {
                        create3DBars();
                    }
                    updateHealthScore();
                    updateFinancialMetrics3D();
                    startMoneyFlow();
                    
                    // Initialize gauges if not already done
                    if (Object.keys(gauges).length === 0 && typeof Gauge !== 'undefined') {
                        initGauges();
                        updateGauges();
                    }
                }, 100);
            } else {
                stopMoneyFlow();
            }
        }

        // Add gauge.js library dynamically
        function loadGaugeLibrary() {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/gauge.js/1.3.7/gauge.min.js';
            script.onload = () => {
                if (currentTab === 'dashboard') {
                    initGauges();
                    updateGauges();
                }
            };
            document.head.appendChild(script);
        }

        // Update the main calculation to refresh dashboard if active
        const originalCalculate = calculate;
        calculate = function() {
            originalCalculate();
            
            if (currentTab === 'dashboard') {
                updateHealthScore();
                updateGauges();
                updateFinancialMetrics3D();
                if (scene3D) {
                    create3DBars();
                }
            }
        };

        // Initialize everything
        window.addEventListener('load', function() {
            initCharts();
            loadGaugeLibrary();
            
            // Set initial values
            document.getElementById('grossSalary').value = 50000;
            document.getElementById('salarySlider').value = 50000;
            document.getElementById('sliderValue').textContent = 'KES 50,000';
            
            calculate();
        });
    </script>
</body>
</html>